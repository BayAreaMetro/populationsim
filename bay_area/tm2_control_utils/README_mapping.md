# TAZ Population Controls Mapping

This directory contains tools for creating interactive maps of PopulationSim control data at the TAZ level.

## Features

- **Interactive Dashboard**: HTML dashboard with radio button selection of metrics
- **Static Maps**: PNG maps for individual metrics  
- **Configurable**: Easy configuration through config.py
- **Flexible**: Automatic detection of TAZ ID fields and numeric columns

## Setup

### 1. Install Dependencies

```bash
pip install -r mapping_requirements.txt
```

### 2. Configure Mapping Settings

Edit `config.py` to set your mapping preferences:

```python
# Mapping configuration
ENABLE_TAZ_MAPPING = True  # Set to False to disable
TAZ_SHAPEFILE_DIR = r"C:\GitHub\tm2py-utils\tm2py_utils\inputs\maz_taz"
TAZ_SHAPEFILE_NAME = "taz_shapes.shp"  # Adjust to your shapefile name
TAZ_JOIN_FIELD = "TAZ"  # Field name in shapefile (TAZ, TAZ_ID, etc.)
MAP_OUTPUT_DIR = "output_2023"  # Output directory
MAP_OUTPUT_FORMAT = "html"  # 'html', 'png', or 'both'
```

### 3. Prepare Your Data

Ensure you have:
- TAZ marginals CSV file (generated by your control creation script)
- TAZ shapefile in the specified directory
- Matching TAZ ID fields between the CSV and shapefile

## Usage

### Option 1: Create All Maps

```bash
python taz_mapper.py
```

This creates an interactive dashboard with all numeric columns available for selection.

### Option 2: Quick Single Map

```bash
python quick_taz_maps.py
```

Creates all maps, or specify a column:

```bash
python quick_taz_maps.py hh_inc_30
```

### Option 3: Use as a Module

```python
from taz_mapper import TAZMapper

mapper = TAZMapper()
mapper.create_all_maps()

# Or create specific map
folium_map = mapper.create_folium_map('hh_size_1', title='Households Size 1')
folium_map.save('my_map.html')
```

## Output Files

Maps are saved to the configured output directory:

- `taz_controls_dashboard.html` - Interactive dashboard with all metrics
- `taz_map_{column}.html` - Individual interactive maps (if HTML format enabled)
- `taz_map_{column}.png` - Individual static maps (if PNG format enabled)

## Troubleshooting

### Common Issues

1. **Shapefile not found**
   - Check `TAZ_SHAPEFILE_DIR` path
   - Ensure shapefile exists with correct name
   - Script will try to auto-detect shapefiles in the directory

2. **No data joins**
   - Check TAZ ID field names match between CSV and shapefile
   - Ensure ID fields are same data type (string/numeric)
   - Script attempts auto-detection of TAZ fields

3. **No numeric columns found**
   - Ensure TAZ marginals CSV has numeric data columns
   - Check that columns have non-zero variance

4. **Import errors**
   - Install required packages: `pip install -r mapping_requirements.txt`
   - Ensure config.py is in the same directory

### Debug Information

The scripts provide detailed console output about:
- Data loading success/failure
- Column detection
- Join statistics
- Output file locations

## Configuration Options

| Setting | Description | Default |
|---------|-------------|---------|
| `ENABLE_TAZ_MAPPING` | Enable/disable mapping | `True` |
| `TAZ_SHAPEFILE_DIR` | Directory containing shapefile | User-specified |
| `TAZ_SHAPEFILE_NAME` | Shapefile name | `"taz_shapes.shp"` |
| `TAZ_JOIN_FIELD` | TAZ ID field in shapefile | `"TAZ"` |
| `MAP_OUTPUT_DIR` | Output directory | `"output_2023"` |
| `MAP_OUTPUT_FORMAT` | Format: 'html', 'png', 'both' | `"html"` |

## Interactive Dashboard Features

The HTML dashboard includes:
- **Radio Button Selection**: Choose metrics dynamically
- **Multiple Base Maps**: OpenStreetMap, Light theme, Dark theme
- **Tooltips**: Hover for TAZ ID and values
- **Statistics Panel**: Total, average, median, min, max
- **Responsive Design**: Works on desktop and mobile
- **Choropleth Coloring**: Automatic color scaling

## Technical Notes

- Uses Folium for interactive maps (Leaflet.js backend)
- GeoPandas for spatial data handling
- Automatic color scaling using yellow-orange-red palette
- Handles missing data gracefully
- Supports any numeric columns in the TAZ marginals data
